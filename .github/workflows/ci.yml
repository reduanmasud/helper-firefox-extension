name: ğŸ”„ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # Code Quality Job
  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run ESLint
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint || echo "âš ï¸ Linting issues found"
        
    - name: ğŸ“Š Code complexity analysis
      run: |
        echo "ğŸ“Š Analyzing code complexity..."
        # Add complexity analysis tools here if needed
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" | wc -l | xargs echo "JavaScript files:"
        
    - name: ğŸ“ Check file sizes
      run: |
        echo "ğŸ“ Checking file sizes..."
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./dist/*" -exec wc -l {} + | sort -n
        
  # Build Verification Job
  build-verification:
    name: ğŸ”¨ Build Verification
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        node-version: [16, 18, 20]
        
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build bundles
      run: |
        echo "ğŸ—ï¸ Building bundles with Node.js ${{ matrix.node-version }}..."
        npm run build:bundles
        
    - name: ğŸ“¦ Build extension
      run: |
        echo "ğŸ“¦ Building extension..."
        npm run build
        
    - name: âœ… Verify build output
      run: |
        echo "âœ… Verifying build output..."
        
        # Check if dist directory exists
        if [ ! -d "dist" ]; then
          echo "âŒ dist directory not found"
          exit 1
        fi
        
        # Check if zip file exists
        if [ ! -f dist/*.zip ]; then
          echo "âŒ Extension zip file not found"
          exit 1
        fi
        
        # Check bundle files
        if [ ! -f "sidebar/markdown-renderer.bundle.js" ]; then
          echo "âŒ Markdown renderer bundle not found"
          exit 1
        fi
        
        if [ ! -f "editor/codemirror.bundle.js" ]; then
          echo "âŒ CodeMirror bundle not found"
          exit 1
        fi
        
        echo "âœ… All build artifacts verified successfully"
        
    - name: ğŸ“Š Build size analysis
      run: |
        echo "ğŸ“Š Build size analysis:"
        echo "Extension package:"
        ls -lh dist/*.zip
        echo ""
        echo "Bundle sizes:"
        ls -lh sidebar/markdown-renderer.bundle.js editor/codemirror.bundle.js
        
  # Extension Validation Job
  extension-validation:
    name: ğŸ¦Š Extension Validation
    runs-on: ubuntu-latest
    needs: build-verification
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build extension
      run: |
        npm run build:bundles
        npm run build
        
    - name: ğŸ¦Š Validate with web-ext
      run: |
        echo "ğŸ¦Š Validating extension with web-ext..."
        npx web-ext lint --source-dir=. --config=web-ext-config.cjs || echo "âš ï¸ Validation warnings found"
        
    - name: ğŸ“‹ Manifest validation
      run: |
        echo "ğŸ“‹ Validating manifest.json..."
        
        # Check if manifest.json exists and is valid JSON
        if ! jq empty manifest.json; then
          echo "âŒ manifest.json is not valid JSON"
          exit 1
        fi
        
        # Check required fields
        REQUIRED_FIELDS=("manifest_version" "name" "version" "description")
        for field in "${REQUIRED_FIELDS[@]}"; do
          if ! jq -e ".$field" manifest.json > /dev/null; then
            echo "âŒ Required field '$field' missing from manifest.json"
            exit 1
          fi
        done
        
        echo "âœ… Manifest validation passed"
        
    - name: ğŸ” Security check
      run: |
        echo "ğŸ” Running security checks..."
        
        # Check for potentially dangerous permissions
        DANGEROUS_PERMS=("tabs" "<all_urls>")
        for perm in "${DANGEROUS_PERMS[@]}"; do
          if jq -e ".permissions[]? | select(. == \"$perm\")" manifest.json > /dev/null; then
            echo "âš ï¸ Potentially sensitive permission found: $perm"
          fi
        done
        
        # Check for eval usage (security risk)
        if grep -r "eval(" --include="*.js" . --exclude-dir=node_modules --exclude-dir=dist; then
          echo "âš ï¸ eval() usage found - potential security risk"
        else
          echo "âœ… No eval() usage found"
        fi
        
  # Documentation Check Job
  documentation-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“š Check documentation files
      run: |
        echo "ğŸ“š Checking documentation files..."
        
        REQUIRED_DOCS=("README.md" "LICENSE" "INSTALLATION.md")
        for doc in "${REQUIRED_DOCS[@]}"; do
          if [ ! -f "$doc" ]; then
            echo "âŒ Required documentation file missing: $doc"
            exit 1
          else
            echo "âœ… Found: $doc"
          fi
        done
        
    - name: ğŸ“ Check README completeness
      run: |
        echo "ğŸ“ Checking README completeness..."
        
        REQUIRED_SECTIONS=("Installation" "Features" "Usage" "Author")
        for section in "${REQUIRED_SECTIONS[@]}"; do
          if ! grep -i "## $section\|# $section" README.md > /dev/null; then
            echo "âš ï¸ README section might be missing: $section"
          else
            echo "âœ… Found section: $section"
          fi
        done
        
  # Performance Check Job
  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: build-verification
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build extension
      run: |
        npm run build:bundles
        npm run build
        
    - name: âš¡ Performance analysis
      run: |
        echo "âš¡ Analyzing extension performance..."
        
        # Check bundle sizes
        echo "ğŸ“¦ Bundle size analysis:"
        MARKDOWN_SIZE=$(stat -f%z sidebar/markdown-renderer.bundle.js 2>/dev/null || stat -c%s sidebar/markdown-renderer.bundle.js)
        CODEMIRROR_SIZE=$(stat -f%z editor/codemirror.bundle.js 2>/dev/null || stat -c%s editor/codemirror.bundle.js)
        TOTAL_SIZE=$(stat -f%z dist/*.zip 2>/dev/null || stat -c%s dist/*.zip)
        
        echo "Markdown renderer bundle: $(($MARKDOWN_SIZE / 1024))KB"
        echo "CodeMirror bundle: $(($CODEMIRROR_SIZE / 1024))KB"
        echo "Total extension size: $(($TOTAL_SIZE / 1024))KB"
        
        # Warn if bundles are too large
        if [ $MARKDOWN_SIZE -gt 500000 ]; then
          echo "âš ï¸ Markdown renderer bundle is large (>500KB)"
        fi
        
        if [ $CODEMIRROR_SIZE -gt 1000000 ]; then
          echo "âš ï¸ CodeMirror bundle is large (>1MB)"
        fi
        
        if [ $TOTAL_SIZE -gt 5000000 ]; then
          echo "âš ï¸ Extension package is large (>5MB)"
        fi
        
  # Summary Job
  ci-summary:
    name: ğŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, build-verification, extension-validation, documentation-check, performance-check]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate CI Summary
      run: |
        echo "ğŸ“Š ScriptForge Inspector CI Summary"
        echo "=================================="
        echo ""
        echo "ğŸ” Code Quality: ${{ needs.code-quality.result }}"
        echo "ğŸ”¨ Build Verification: ${{ needs.build-verification.result }}"
        echo "ğŸ¦Š Extension Validation: ${{ needs.extension-validation.result }}"
        echo "ğŸ“š Documentation Check: ${{ needs.documentation-check.result }}"
        echo "âš¡ Performance Check: ${{ needs.performance-check.result }}"
        echo ""
        
        # Determine overall status
        if [[ "${{ needs.code-quality.result }}" == "success" && 
              "${{ needs.build-verification.result }}" == "success" && 
              "${{ needs.extension-validation.result }}" == "success" && 
              "${{ needs.documentation-check.result }}" == "success" && 
              "${{ needs.performance-check.result }}" == "success" ]]; then
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "âœ… ScriptForge Inspector is ready for deployment"
        else
          echo "âŒ Some CI checks failed"
          echo "ğŸ”§ Please review and fix the issues above"
        fi
        
        echo ""
        echo "ğŸ“‹ Next Steps:"
        echo "- Review any warnings or failures above"
        echo "- Fix issues and push changes"
        echo "- Create a release tag to trigger deployment"
